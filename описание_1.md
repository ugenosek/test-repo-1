#### ЗАДАЧА: Зачистить залипшие задания на StorageDomain

*НАПРИМЕР: Отключали/импортировали домен, мигрировали ВМ с одного домена на другой, перемещали диски/файлы, делали бэкапы/снэпшоты, и пр. В результате таких действий могут появиться 'залипшие задания' (stale tasks), одним фактом своего существования препятствующие перемещению роли SPM на другой хост или/и вводу текущего SPM-хоста или StorageDomain в Maintenance.
На работу и доступность пользовательских ВМ, хостов и Engine описанные далее действия никак не влияют.*

#### РЕШЕНИЕ:

---

**0)** проверяем логи Engine на предмет ошибок (на ВМ Engine):
```
cat /var/log/ovirt-engine/engine.log | grep -E "( SPM | ERROR )"
```

---

##### ЭТАП-1: находим и зачищаем залипшие задания на SPM-хосте (на хосте с ролью SPM)
> на основе [[1]](https://blog.it-kb.ru/2018/08/19/ovirt-4-2-5-failed-to-force-select-host-as-the-spm-due-to-a-failure-to-stop-the-current-spm-with-uncleared-vdsm-tasks/)

**1.0)** проверяем логи Engine на предмет ошибок (на ВМ Engine)

**1.1)** Убеждаемся в GUI Engine, что нет активных задач (Tasks):

**1.2)** Выясняем ID залипших заданий на SPM-хосте:
```
vdsm-client Host getAllTasksInfo
```

**1.3)** Для каждого из полученных ID зачищаем задания на SPM-хосте:
```
vdsm-client Task clear taskID=<task_id>
```

---

##### ЭТАП-2: зачищаем записи в БД Engine (на ВМ Engine)
> на основе [[2]](https://lists.ovirt.org/archives/list/users@ovirt.org/message/24D3PHPSNEHUEPSX5ATL7RCTUHH74D5Y/)
> про вспомогательные скрипты oVirt: [[3]](https://www.ovirt.org/develop/developer-guide/db-issues/helperutilities.html)

**2.1)** Выясняем все текущие асинхронные задания через psql (на ВМ Engine):
```
su - postgres
psql -d engine -U postgres
engine=# select task_id,started_at from async_tasks;
```

>> здесь нам важно получить id целевых заданий напрямую из БД Engine (эти id отличаются от тех, что выдает vdsm-client Host getAllTasksInfo)

**2.2)** Удаляем все текущие АСИНХронные задания скриптом **taskcleaner.sh** (на ВМ Engine):
```
/usr/share/ovirt-engine/setup/dbutils/taskcleaner.sh -v -s -t <task_id>
```

>> повторяем для всех id асинхронных заданий, полученных из таблицы 'async_tasks'
>> ключ "-v" [verbose] повышает подробность вывода работы скрипта, ключ "-s" [silent] отключает запросы на подтверждение очистки

**2.3)** Дополнительно зачищаем список ВСЕХ заданий [*-R: Removes all tasks (use with -z to clear only zombie tasks)*] скриптом **taskcleaner.sh** (на ВМ Engine):
```
/usr/share/ovirt-engine/setup/dbutils/taskcleaner.sh -v -R
```
>> этот шаг НЕобязателен

---
